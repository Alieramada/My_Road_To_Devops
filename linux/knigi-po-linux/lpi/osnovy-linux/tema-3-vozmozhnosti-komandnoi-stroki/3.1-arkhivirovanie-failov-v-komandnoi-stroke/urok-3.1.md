# Урок 3.1

## &#x20;Введение

Сжатие используется для уменьшения объема пространства, занимаемого определенным набором данных. Сжатие обычно используется для уменьшения объема пространства, необходимого для хранения файла. Еще одним распространенным способом использования является уменьшение объема данных, передаваемых по сетевому соединению.

Сжатие работает путем замены повторяющихся шаблонов в данных. Предположим, у вас есть роман. Некоторые слова чрезвычайно распространены, но состоят из нескольких символов, например, слово “the”. Вы могли бы значительно уменьшить размер романа, если бы заменили эти распространенные многосимвольные слова и шаблоны односимвольными заменами. Например, замените “the” греческой буквой, которая больше нигде в тексте не используется. Алгоритмы сжатия данных аналогичны этому, но более сложны.

Сжатие бывает двух видов: _без потерь_ и _с потерями_. Данные, сжатые с помощью алгоритма без потерь, можно распаковать обратно в исходную форму. Данные, сжатые с помощью алгоритма с потерями, восстановить невозможно. Алгоритмы с потерями часто используются для изображений, видео и аудио, где потеря качества незаметна для человека, не имеет значения для контекста или стоит того, чтобы сэкономить место или пропускную способность сети.

Инструменты архивирования используются для объединения файлов и каталогов в один файл. Наиболее распространённые варианты использования — резервное копирование, объединение исходного кода программного обеспечения и хранение данных.

Архивирование и сжатие обычно используются вместе. Некоторые инструменты для архивирования даже сжимают содержимое по умолчанию. Другие могут дополнительно сжимать содержимое. Некоторые инструменты для архивирования необходимо использовать в сочетании с автономными инструментами для сжатия, если вы хотите сжать содержимое.

Наиболее распространённым инструментом для архивирования файлов в системах Linux является `tar`. Большинство дистрибутивов Linux поставляются с версией `tar` от GNU, поэтому в этом уроке мы рассмотрим именно её. `tar` сам по себе только архивирует файлы, но не сжимает их.

В Linux доступно множество инструментов сжатия. Наиболее распространенными средствами сжатия без потерь являются `bzip2`, `gzip` и `xz`. Все три вы найдете в большинстве систем. Вы можете столкнуться со старой или очень минимальной системой, в которой не установлена `xz` или `bzip`. Если вы станете обычным пользователем Linux, вы, вероятно, столкнетесь с файлами, сжатыми всеми тремя из них. Все три из них используют разные алгоритмы, поэтому файл, сжатый одним инструментом, не может быть распакован другим. У инструментов сжатия есть компромисс. Если вам нужна высокая степень сжатия, на сжатие и распаковку файла уйдет больше времени. Это связано с тем, что при более высоком сжатии требуется больше работы по поиску более сложных шаблонов. Все эти инструменты сжимают данные, но не могут создавать архивы, содержащие несколько файлов.

Автономные средства сжатия обычно недоступны в системах Windows. Средства архивирования и сжатия Windows обычно поставляются в комплекте. Имейте это в виду, если у вас системы Linux и Windows, которым необходимо совместно использовать файлы.

В системах Linux также есть инструменты для обработки `.zip` файлов, обычно используемых в системе Windows. Они называются `zip` и `unzip`. Эти инструменты установлены по умолчанию не во всех системах, поэтому, если вам нужно их использовать, возможно, вам придется их установить. К счастью, они обычно находятся в репозиториях пакетов дистрибутивов.

## &#x20;Инструменты сжатия

Количество дискового пространства, которое можно сэкономить при сжатии файлов, зависит от нескольких факторов. От характера данных, которые вы сжимаете, алгоритма сжатия и уровня сжатия. Не все алгоритмы поддерживают разные уровни сжатия.

Давайте начнем с настройки некоторых тестовых файлов для сжатия:

```
$ mkdir ~/linux_essentials-3.1
$ cd ~/linux_essentials-3.1
$ mkdir compression archiving
$ cd compression
$ cat /etc/* > bigfile 2> /dev/null
```

Теперь мы создаем три копии этого файла:

```
Теперь мы создаем три копии этого файла:
```

<pre><code><strong>$ cp bigfile bigfile2
</strong><strong>$ cp bigfile bigfile3
</strong><strong>$ cp bigfile bigfile4
</strong><strong>$ ls -lh
</strong>total 2.8M
-rw-r--r-- 1 emma emma 712K Jun 23 08:08 bigfile
-rw-r--r-- 1 emma emma 712K Jun 23 08:08 bigfile2
-rw-r--r-- 1 emma emma 712K Jun 23 08:08 bigfile3
-rw-r--r-- 1 emma emma 712K Jun 23 08:08 bigfile4
</code></pre>

Теперь мы собираемся сжать файлы с помощью каждого вышеупомянутого инструмента сжатия:

```
$ bzip2 bigfile2
$ gzip bigfile3
$ xz bigfile4
$ ls -lh
total 1.2M
-rw-r--r-- 1 emma emma 712K Jun 23 08:08 bigfile
-rw-r--r-- 1 emma emma 170K Jun 23 08:08 bigfile2.bz2
-rw-r--r-- 1 emma emma 179K Jun 23 08:08 bigfile3.gz
-rw-r--r-- 1 emma emma 144K Jun 23 08:08 bigfile4.xz
```

Сравните размеры сжатых файлов с размерами несжатого файла с именем `bigfile`. Также обратите внимание, как инструменты сжатия добавили расширения к именам файлов и удалили несжатые файлы.

Используйте `bunzip2`, `gunzip` или `unxz` для распаковки файлов

```
$ bunzip2 bigfile2.bz2
$ gunzip bigfile3.gz
$ unxz bigfile4.xz
$ ls -lh
total 2.8M
-rw-r--r-- 1 emma emma 712K Jun 23 08:20 bigfile
-rw-r--r-- 1 emma emma 712K Jun 23 08:20 bigfile2
-rw-r--r-- 1 emma emma 712K Jun 23 08:20 bigfile3
-rw-r--r-- 1 emma emma 712K Jun 23 08:20 bigfile4
```

Обратите внимание еще раз, что теперь сжатый файл удаляется после его распаковки.

Некоторые инструменты сжатия поддерживают разные уровни сжатия. Более высокий уровень сжатия обычно требует больше памяти и циклов процессора, но приводит к уменьшению размера сжатого файла. Для более низкого уровня верно обратное. Ниже приведена демонстрация с `xz` и `gzip`:

```
$ cp bigfile bigfile-gz1
$ cp bigfile bigfile-gz9
$ gzip -1 bigfile-gz1
$ gzip -9 bigfile-gz9
$ cp bigfile bigfile-xz1
$ cp bigfile bigfile-xz9
$ xz -1 bigfile bigfile-xz1
$ xz -9 bigfile bigfile-xz9
$ ls -lh bigfile bigfile-* *
total 3.5M
-rw-r--r-- 1 emma emma 712K Jun 23 08:08 bigfile
-rw-r--r-- 1 emma emma 205K Jun 23 13:14 bigfile-gz1.gz
-rw-r--r-- 1 emma emma 178K Jun 23 13:14 bigfile-gz9.gz
-rw-r--r-- 1 emma emma 156K Jun 23 08:08 bigfile-xz1.xz
-rw-r--r-- 1 emma emma 143K Jun 23 08:08 bigfile-xz9.xz
```

Нет необходимости распаковывать файл каждый раз, когда вы его используете. Инструменты сжатия обычно поставляются со специальными версиями распространённых инструментов, используемых для чтения текстовых файлов. Например, `gzip` имеет версии `cat`, `grep`, `diff`, `less`, `more` и несколько других. Для `gzip` инструменты имеют префикс `z`, а префикс `bz` существует для `bzip2` и `xz` существует для `xz`. Ниже приведён пример использования `zcat` для чтения и отображения файла, сжатого с помощью `gzip`:

```
$ cp /etc/hosts ./
$ gzip hosts
$ zcat hosts.gz
127.0.0.1	localhost

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

## &#x20;Инструменты архивирования

Программа `tar` является, пожалуй, самым распространённым инструментом архивирования в системах Linux. Если вам интересно, почему она так называется, то это сокращение от «ленточный архив(tape archive)». Файлы, созданные с помощью `tar`, часто называют _tar-архивами_. Очень часто приложения, распространяемые в виде исходного кода, находятся в tar-архивах.

В версии GNU `tar` для дистрибутивов Linux есть множество опций. В этом уроке мы рассмотрим наиболее часто используемое подмножество.

Давайте начнём с создания архива файлов, используемых для сжатия:

```
$ cd ~/linux_essentials-3.1
$ tar cf archiving/3.1.tar compression
```

Опция `c` указывает `tar` на создание нового архивного файла, а опция `f` — это имя создаваемого файла. Аргумент, следующий сразу за опциями, всегда будет именем файла, с которым вы работаете. Остальные аргументы — это пути к любым файлам или каталогам, которые вы хотите добавить в файл, вывести в список или извлечь из файла. В этом примере мы добавляем в архив каталог `compression` и всё его содержимое.

Чтобы просмотреть содержимое tar-архива, используйте опцию `t` в `tar`:

```
$ tar -tf 3.1.tar
compression/
compression/bigfile-xz1.xz
compression/bigfile-gz9.gz
compression/hosts.gz
compression/bigfile2
compression/bigfile
compression/bigfile-gz1.gz
compression/bigfile-xz9.xz
compression/bigfile3
compression/bigfile4
```

Обратите внимание, что опциям предшествует буква `-`. В отличие от большинства программ, в `tar`, `-` при указании опций не требуется, хотя это не причинит никакого вреда при его использовании.

{% hint style="info" %}
Вы можете использовать параметр `-v` для вывода имён файлов, с которыми работает `tar` при создании или извлечении архива.
{% endhint %}

Теперь давайте распакуем файл:

```
$ cd ~/linux_essentials-3.1/archiving
$ ls
3.1.tar
$ tar xf 3.1.tar
$ ls
3.1.tar  compression
```

Предположим, вам нужен только один файл из архива. В этом случае вы можете указать его после имени файла архива. При необходимости можно указать несколько файлов:

```
$ cd ~/linux_essentials-3.1/archiving
$ rm -rf compression
$ ls
3.1.tar
$ tar xvf 3.1.tar compression/hosts.gz
compression/
compression/bigfile-xz1.xz
compression/bigfile-gz9.gz
compression/hosts.gz
compression/bigfile2
compression/bigfile
compression/bigfile-gz1.gz
compression/bigfile-xz9.xz
compression/bigfile3
compression/bigfile4
$ ls
3.1.tar  compression
$ ls compression
hosts.gz
```

За исключением абсолютных путей (путей, начинающихся с `/`), `tar` файлы сохраняют весь путь к файлам при их создании. Поскольку файл `3.1.tar` был создан с одним каталогом, при извлечении этот каталог будет создан относительно вашего текущего рабочего каталога. Другой пример поможет прояснить ситуацию:

```
$ cd ~/linux_essentials-3.1/archiving
$ rm -rf compression
$ cd ../compression
$ tar cf ../tar/3.1-nodir.tar *
$ cd ../archiving
$ mkdir untar
$ cd untar
$ tar -xf ../3.1-nodir.tar
$ ls
bigfile   bigfile3  bigfile-gz1.gz  bigfile-xz1.xz  hosts.gz
bigfile2  bigfile4  bigfile-gz9.gz  bigfile-xz9.xz
```

{% hint style="info" %}
Если вы хотите использовать абсолютный путь в файле `tar`, вам нужно использовать опцию `P` . Имейте в виду, что это может привести к перезаписи важных файлов и ошибкам в вашей системе.
{% endhint %}

Программа `tar` также может управлять сжатием и распаковкой архивов "на лету". `tar` делает это, вызывая один из инструментов сжатия, рассмотренных ранее в этом разделе. Это так же просто, как добавить опцию, соответствующую алгоритму сжатия. Наиболее часто используемыми являются `j`, `J` и `z` для `bzip2`, `xz` и `gzip` соответственно. Ниже приведены примеры использования вышеупомянутых алгоритмов:

```
$ cd ~/linux_essentials-3.1/compression
$ ls
bigfile   bigfile3  bigfile-gz1.gz  bigfile-xz1.xz  hosts.gz
bigfile2  bigfile4  bigfile-gz9.gz  bigfile-xz9.xz
$ tar -czf gzip.tar.gz bigfile bigfile2 bigfile3
$ tar -cjf bzip2.tar.bz2 bigfile bigfile2 bigfile3
$ tar -cJf xz.tar.xz bigfile bigfile2 bigfile3
$ ls -l | grep tar
-rw-r--r-- 1 emma emma  450202 Jun 27 05:56 bzip2.tar.bz2
-rw-r--r-- 1 emma emma  548656 Jun 27 05:55 gzip.tar.gz
-rw-r--r-- 1 emma emma  147068 Jun 27 05:56 xz.tar.xz
```

Обратите внимание, что в этом примере файлы `.tar` имеют разный размер. Это означает, что они были успешно сжаты. Если вы создаёте сжатые архивы `.tar` , вы всегда должны добавлять второе расширение файла, обозначающее используемый алгоритм. Это `.xz`, `.bz`, и `.gz` для `xz`, `bzip2`, и `gzip` соответственно. Иногда используются сокращённые расширения, например `.tgz` .

Можно добавлять файлы в уже существующие несжатые архивы tar. Для этого используйте опцию `u`. Если вы попытаетесь добавить файл в сжатый архив, вы получите сообщение об ошибке.

```
$ cd ~/linux_essentials-3.1/compression
$ ls
bigfile   bigfile3  bigfile-gz1.gz  bigfile-xz1.xz  bzip2.tar.bz2  hosts.gz
bigfile2  bigfile4  bigfile-gz9.gz  bigfile-xz9.xz  gzip.tar.gz    xz.tar.xz
$ tar cf plain.tar bigfile bigfile2 bigfile3
$ tar tf plain.tar
bigfile
bigfile2
bigfile3
$ tar uf plain.tar bigfile4
$ tar tf plain.tar
bigfile
bigfile2
bigfile3
bigfile4
$ tar uzf gzip.tar.gz bigfile4
tar: Cannot update compressed archives
Try 'tar --help' or 'tar --usage' for more information.
```

## &#x20;Управление ZIP-файлами

На компьютерах с Windows часто нет приложений для работы с архивами или многих инструментов сжатия, которые обычно есть в системах Linux. Если вам нужно взаимодействовать с системами Windows, вы можете использовать ZIP-файлы. ZIP-файл — это архивный файл, похожий на сжатый `tar` файл.

Программы `zip` и `unzip` можно использовать для работы с ZIP-файлами в системах Linux. Приведённый ниже пример должен помочь вам начать их использовать. Сначала мы создадим набор файлов:

```
$ cd ~/linux_essentials-3.1
$ mkdir zip
$ cd zip/
$ mkdir dir
$ touch dir/file1 dir/file2
```

Теперь мы используем `zip` для упаковки этих файлов в ZIP-файл:

```
$ zip -r zipfile.zip dir
  adding: dir/ (stored 0%)
  adding: dir/file1 (stored 0%)
  adding: dir/file2 (stored 0%)
$ rm -rf dir
```

Наконец, мы снова распаковываем ZIP-файл:

```
$ ls
zipfile.zip
$ unzip zipfile.zip
Archive:  zipfile.zip
   creating: dir/
 extracting: dir/file1
 extracting: dir/file2
$ find
.
./zipfile.zip
./dir
./dir/file1
./dir/file2
```

При добавлении каталогов в ZIP-файлы опция `-r` позволяет `zip` включить содержимое каталога. Без неё в ZIP-файле будет пустой каталог.

## &#x20;Упражнения с руководством

1.  Судя по расширениям, какие из следующих инструментов использовались для создания этих файлов?

    | Имя файла        | `tar` | `gzip` | `bzip2` | `xz` |
    | ---------------- | ----- | ------ | ------- | ---- |
    | `archive.tar`    |       |        |         |      |
    | `archive.tgz`    |       |        |         |      |
    | `archive.tar.xz` |       |        |         |      |
2.  Судя по расширениям, какие из этих файлов являются архивами, а какие — сжатыми?

    | Имя файла      | Архив | Сжатый |
    | -------------- | ----- | ------ |
    | `file.tar`     |       |        |
    | `file.tar.bz2` |       |        |
    | `file.zip`     |       |        |
    | `file.xz`      |       |        |
3. Как бы вы добавили файл в `gzip` сжатый `tar` файл?
4. Какой `tar` параметр предписывает `tar` включать начало `/` в абсолютные пути?
5. Поддерживает ли `zip` разные уровни сжатия?

## &#x20;Исследовательские упражнения

1. Поддерживает ли `tar` при извлечении файлов глоббинг (шаблоны) в списке файлов?
2. Как убедиться, что распакованный файл идентичен исходному?
3. Что произойдёт, если вы попытаетесь извлечь файл из архива `tar`, который уже существует в вашей файловой системе?
4. Как бы вы извлекли файл, `archive.tgz` не используя `tar` `z` опцию?

## &#x20;Краткие сведения

В системах Linux доступно несколько инструментов для сжатия и архивирования. В этом уроке мы рассмотрели наиболее распространённые из них. Самый распространённый инструмент для архивирования — `tar`. Если необходимо взаимодействие с системами Windows, `zip` и `unzip` могут создавать и извлекать ZIP-файлы.

У команды `tar` есть несколько параметров, которые стоит запомнить. Это `x` для извлечения, `c` для создания, `t` для просмотра содержимого и `u` для добавления или замены файлов. Параметр `v` перечисляет файлы, которые обрабатываются `tar` при создании или извлечении архива.

В репозитории типичного дистрибутива Linux есть множество инструментов сжатия. Наиболее распространёнными являются `gzip`, `bzip2`, и `xz`. Алгоритмы сжатия часто поддерживают различные уровни, которые позволяют оптимизировать скорость или размер файла. Файлы можно распаковать с помощью `gunzip`, `bunzip2`, и `unxz`.

В инструментах сжатия обычно есть программы, которые ведут себя как обычные инструменты для работы с текстовыми файлами, с той разницей, что они работают со сжатыми файлами. Вот некоторые из них: `zcat`, `bzcat`, и `xzcat`. Инструменты сжатия обычно поставляются с программами с функциями `grep`, `more`, `less`, `diff`, и `cmp`.

Команды, используемые в упражнениях:

`bunzip2`

Распаковать `bzip2` сжатый файл.

`bzcat`

Вывести содержимое `bzip` сжатого файла.

`bzip2`

Сжать файлы, используя `bzip2` алгоритм и формат.

`gunzip`

Распаковать `gzip` сжатый файл.

`gzip`

Сжать файлы, используя `gzip` алгоритм и формат.

`tar`

Создавать, обновлять, перечислять и распаковывать `tar` архивы.

`unxz`

Распаковать `xz` сжатый файл.

`unzip`

Распаковывать и извлекать содержимое из ZIP-файла.

`xz` Сжать файлы, используя `xz` алгоритм и формат.

`zcat`

Вывести содержимое `gzip` сжатого файла.

`zip`

Создание и сжатие ZIP-архивов.

## &#x20;Ответы на упражнения с руководством

1.  Судя по расширениям, какие из следующих инструментов использовались для создания этих файлов?

    | Имя файла        | `tar` | `gzip` | `bzip2` | `xz` |
    | ---------------- | ----- | ------ | ------- | ---- |
    | `archive.tar`    | X     |        |         |      |
    | `archive.tgz`    | X     | X      |         |      |
    | `archive.tar.xz` | X     |        |         | X    |
2.  Судя по расширениям, какие из этих файлов являются архивами, а какие — сжатыми?

    | Имя файла      | Архив | Сжатый |
    | -------------- | ----- | ------ |
    | `file.tar`     | X     |        |
    | `file.tar.bz2` | X     | X      |
    | `file.zip`     | X     | X      |
    | `file.xz`      |       | X      |
3.  Как бы вы добавили файл в `gzip` сжатый `tar` файл?

    Распакуете файл с помощью `gunzip`, добавите файл с помощью `tar uf` и затем сожмёте его с помощью `gzip`
4.  Какой `tar` параметр предписывает `tar` включать начало `/` в абсолютные пути?

    Опция `-P`. Со страницы руководства:

```
-P, --absolute-names
        Don't strip leading slashes from file names when creating  archives
```

5.  Поддерживает ли `zip` разные уровни сжатия?

    Да. Вы бы использовали `-#`, заменив `#` на число от 0 до 9. Из справочной страницы:

```
-#
(-0, -1, -2, -3, -4, -5, -6, -7, -8, -9)
       Regulate the speed of compression using the specified  digit  #,
       where  -0  indicates  no compression (store all files), -1 indi‐
       cates the fastest compression speed (less  compression)  and  -9
       indicates  the  slowest  compression speed (optimal compression,
       ignores the suffix list). The default compression level is -6.

       Though still being worked, the intention is  this  setting  will
       control  compression  speed  for  all compression methods.  Cur‐
       rently only deflation is controlled.
```

1.  Поддерживает ли `tar` при извлечении файлов глобусы в списке файлов?

    Да, вы можете использовать опцию `--wildcards`. `--wildcards` должна быть размещена сразу после файла `tar` при использовании стиля опций без тире. Например:

```
$ tar xf tarfile.tar --wildcards dir/file*
$ tar --wildcards -xf tarfile.tar dir/file*
```



2. Как убедиться, что распакованный файл идентичен исходному?

Вам не нужно ничего делать с инструментами, описанными в этом уроке. Все три из них включают контрольные суммы в формат файлов, которые проверяются при распаковке.

3. Что произойдёт, если вы попытаетесь извлечь файл из архива `tar`, который уже существует в вашей файловой системе?

Файл в вашей файловой системе перезаписывается версией из файла `tar` .

4. Как бы вы извлекли файл, `archive.tgz` не используя `tar` `z` опцию?

Сначала вы бы распаковали его с помощью `gunzip`.

```
$ gunzip archive.tgz
$ tar xf archive.tar
```



